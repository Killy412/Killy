---
title: 深入理解JVM虚拟机-类加载
date: 2021-05-17 20:44:31
tags:
  - "JVM"
  - "类加载机制"
categories: "JVM"
---

## 类的生命周期

主要分为**加载->链接->初始化->使用->卸载**几个过程. 

- 加载

  跟去类的全限定名找到对应的class字节码文件,读取class文件,把静态数据结构转化为运行时数据结构,创建一个class对象,作为数据访问的入口.

- 链接

  - 验证: 检查字节码文件是否符合jvm规范,是否会危害jvm的安全.
  - 准备: 为static变量分配内存,同时赋初始值.
  - 解析: 把常量池中的符号引用转为直接引用.

- 初始化.

  执行类构造器`clinit()`函数,是由static变量赋值和static代码块组合而成.

  **遇到new/getstatic/putstatic/invokestatic才会执行类的初始化过程.**

<!--more-->

### 什么时候会执行类加载的过程

- 遇到new/getstatic/putstatic/invokestatic指令
- 加载子类之前会检查父类是否加载.
- 虚拟机启动,先加载main方法所在类.
- 使用反射操作类时.

以上几种是主动引用,会触发类的初始化操作. 被动引用不会触发类的初始化操作,例如:

- 通过子类引用父类的静态变量
- 定义类的数组
- 使用类静态常量不会触发.

### 类加载器有几种

- 启动类加载器: 由C++编写,加载rt.jar包中的类.
- 扩展类加载器: java实现,加载java.ext.dir属性中的类.
- 程序类加载器: 加载用户类路径下的类.
- 自定义类加载器: 用户自己实现的类加载器.

### 双亲委派机制

为了保证核心类的安全. 

类加载时首先交给父类加载器去加载. 父类加载不了,再由子类加载器去加载.
